#include "esp_camera.h"
#include <WiFi.h>
#include "esp_http_server.h"


const char* ssid = "****";
const char* password = "****";


// Motor Pins
#define M1_IN1 4
#define M1_IN2 5
#define M1_EN  6  // PWM Pin
#define M2_IN1 7
#define M2_IN2 8
#define M2_EN  9  // PWM Pin


int speedVal = 220; // Set slightly higher for reliability
httpd_handle_t camera_httpd = NULL;


void motorsStop() {
 digitalWrite(M1_IN1, LOW); digitalWrite(M1_IN2, LOW);
 digitalWrite(M2_IN1, LOW); digitalWrite(M2_IN2, LOW);
 ledcWrite(M1_EN, 0); ledcWrite(M2_EN, 0);
}


void move(int m1a, int m1b, int m2a, int m2b) {
 // 1. Set Direction First
 digitalWrite(M1_IN1, m1a); digitalWrite(M1_IN2, m1b);
 digitalWrite(M2_IN1, m2a); digitalWrite(M2_IN2, m2b);
  // 2. Kickstart the PWM
 ledcWrite(M1_EN, speedVal);
 ledcWrite(M2_EN, speedVal);
  Serial.println("Motors Moving...");
}


// --- Minimal HTML for Testing ---
static const char PROGMEM INDEX_HTML[] = R"rawliteral(
<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width,initial-scale=1">
<style>button{width:80px;height:80px;font-weight:bold;margin:10px;}</style></head>
<body>
 <h2>MOTOR TEST MODE</h2>
 <button onmousedown="f('fwd')" onmouseup="f('stop')">FWD</button><br>
 <button onmousedown="f('left')" onmouseup="f('stop')">LEFT</button>
 <button onmousedown="f('right')" onmouseup="f('stop')">RIGHT</button><br>
 <button onmousedown="f('rev')" onmouseup="f('stop')">REV</button>
 <script>function f(c){fetch('/cmd?go='+c);}</script>
</body></html>)rawliteral";


static esp_err_t cmd_handler(httpd_req_t *req){
 char buf[32];
 if (httpd_req_get_url_query_str(req, buf, 32) == ESP_OK) {
   char p[16];
   if (httpd_query_key_value(buf, "go", p, 16) == ESP_OK) {
     if(!strcmp(p, "fwd")) move(0,1,0,1);
     else if(!strcmp(p, "rev")) move(1,0,1,0);
     else if(!strcmp(p, "left")) move(1,0,0,1);
     else if(!strcmp(p, "right")) move(0,1,1,0);
     else motorsStop();
   }
 }
 return httpd_resp_send(req, "OK", 2);
}


void setup() {
 Serial.begin(115200);
  pinMode(M1_IN1, OUTPUT); pinMode(M1_IN2, OUTPUT); pinMode(M1_EN, OUTPUT);
 pinMode(M2_IN1, OUTPUT); pinMode(M2_IN2, OUTPUT); pinMode(M2_EN, OUTPUT);


 // Setup PWM
 ledcAttach(M1_EN, 20000, 8);
 ledcAttach(M2_EN, 20000, 8);
 motorsStop();


 WiFi.begin(ssid, password);
 while (WiFi.status() != WL_CONNECTED) delay(500);


 httpd_config_t s_config = HTTPD_DEFAULT_CONFIG();
 if (httpd_start(&camera_httpd, &s_config) == ESP_OK) {
   httpd_register_uri_handler(camera_httpd, new httpd_uri_t{"/", HTTP_GET, [](httpd_req_t *r){return httpd_resp_send(r, INDEX_HTML, HTTPD_RESP_USE_STRLEN);}, NULL});
   httpd_register_uri_handler(camera_httpd, new httpd_uri_t{"/cmd", HTTP_GET, cmd_handler, NULL});
 }
 Serial.println(WiFi.localIP());
}


void loop() { delay(1); }
